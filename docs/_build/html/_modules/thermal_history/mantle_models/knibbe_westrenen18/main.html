

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>thermal_history.mantle_models.knibbe_westrenen18.main &mdash; thermal_history  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> thermal_history
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../simple_example.html">Running a simple example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Advanced.html">Adding new methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../API_index.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">thermal_history</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>thermal_history.mantle_models.knibbe_westrenen18.main</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for thermal_history.mantle_models.knibbe_westrenen18.main</h1><div class="highlight"><pre>
<span></span><span class="n">Description</span> <span class="o">=</span> <span class="s1">&#39;Mantle model based on Knibbe and van Westrenen (2018) for Mercury.</span><span class="se">\</span>
<span class="s1">Stagnant lid plate tectonics is assumed with growth of crust by mantle melting.&#39;</span>


<span class="c1">#Import statements</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">trapezoid</span>

<span class="kn">from</span> <span class="nn">.routines</span> <span class="kn">import</span> <span class="n">profiles</span> <span class="k">as</span> <span class="n">prof</span>
<span class="kn">from</span> <span class="nn">.routines</span> <span class="kn">import</span> <span class="n">melting</span> <span class="k">as</span> <span class="n">melt</span>


<span class="c1">#setup, evolve, and update functions</span>
<div class="viewcode-block" id="setup"><a class="viewcode-back" href="../../../../thermal_history.mantle_models.knibbe_westrenen18.main.html#thermal_history.mantle_models.knibbe_westrenen18.main.setup">[docs]</a><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Include any code that should be run after parameters have been loaded in and before 1st iteration is run.</span>
<span class="sd">    E.g. set any initial conditions as attributes of the model.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mantle</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mantle</span>
    <span class="n">prm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span>


    <span class="c1">#Assign initial conditions</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Tm</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">Tm</span><span class="p">)</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">delta_upper</span><span class="p">,</span> <span class="n">mantle</span><span class="o">.</span><span class="n">delta_lower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="c1">#Initialise TBL thickness</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Dl</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">stagnant_lid_thickness</span><span class="p">)</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">D_crust</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_surf</span> <span class="o">-</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_crust</span>


    <span class="c1">#Calculate the total budget of radiogenic heating at present. Used for calculating Qr at each timestep.</span>

    <span class="c1">#Mass fractions of K, U, Th</span>
    <span class="n">c_K</span><span class="p">,</span> <span class="n">c_U</span><span class="p">,</span> <span class="n">c_Th</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">HPE_concentrations</span> <span class="c1">#Present day K, U, Th concentrations (wt %) #1288e-6, 90e-6, 155e-6  #Tosi et al. (2013)</span>

    <span class="c1">#Fraction of radioactive nuclei per atom of element (K40, U238, U235, Th232)</span>
    <span class="c1"># Order of isotopes must be consistent with other properties. Numbers from Sramek et al. 2013</span>
    <span class="n">isotope_abundance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">117e-6</span><span class="p">,</span> <span class="mf">0.9927</span><span class="p">,</span> <span class="mf">0.007204</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1">#Crust mass fraction of radioactive isotopes</span>
    <span class="n">HPE_mass_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c_K</span><span class="p">,</span> <span class="n">c_U</span><span class="p">,</span> <span class="n">c_U</span><span class="p">,</span> <span class="n">c_Th</span><span class="p">])</span> <span class="o">*</span> <span class="n">isotope_abundance</span>
    <span class="n">HPE_atom_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">39.9640</span><span class="p">,</span> <span class="mf">238.051</span><span class="p">,</span> <span class="mf">235.044</span><span class="p">,</span> <span class="mf">232.038</span><span class="p">])</span><span class="o">*</span><span class="mf">1.661e-27</span> <span class="c1">#Atomic masses</span>
    <span class="n">HPE_Q_per_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.110</span><span class="p">,</span> <span class="mf">7.648</span><span class="p">,</span> <span class="mf">7.108</span><span class="p">,</span> <span class="mf">6.475</span><span class="p">])</span><span class="o">*</span><span class="mf">1e-12</span> <span class="c1">#Energy from entire decay chain, J/atom</span>
    <span class="n">HPE_half_lives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.25e9</span><span class="p">,</span> <span class="mf">7.04e8</span><span class="p">,</span> <span class="mf">4.47e9</span><span class="p">,</span> <span class="mf">1.40e10</span><span class="p">])</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">ys</span>  <span class="c1">#Half lives in seconds</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">HPE_mass_fraction</span><span class="o">/</span><span class="n">HPE_atom_mass</span> <span class="o">*</span> <span class="n">HPE_Q_per_atom</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">HPE_half_lives</span>
    <span class="n">r_crust</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_surf</span><span class="o">-</span><span class="mf">38e3</span>
    
    <span class="c1">#FIX TO KW18 NUMBERS FOR NOW. heating rate @ 4.3 Ga</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e-11</span><span class="o">*</span><span class="p">(</span><span class="mi">1288</span><span class="o">/</span><span class="mi">265</span><span class="p">),</span> <span class="mf">7e-12</span><span class="o">*</span><span class="p">(</span><span class="mi">90</span><span class="o">/</span><span class="mi">20</span><span class="p">),</span> <span class="mf">3.5e-12</span><span class="o">*</span><span class="p">(</span><span class="mi">90</span><span class="o">/</span><span class="mi">20</span><span class="p">),</span> <span class="mf">2e-12</span><span class="o">*</span><span class="p">(</span><span class="mi">155</span><span class="o">/</span><span class="mi">69</span><span class="p">)])</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">4.3e9</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">ys</span><span class="p">)</span><span class="o">/</span><span class="n">HPE_half_lives</span><span class="p">)</span>

    <span class="c1">#Present day total radiogenic heating assuming a 38km crust.</span>
    <span class="n">Q_total</span> <span class="o">=</span>   <span class="n">H</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">crust_density</span>                  <span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">r_surf</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">r_crust</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> \
              <span class="o">+</span> <span class="n">H</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">HPE_fraction</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">mantle_density</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">r_crust</span><span class="o">**</span><span class="mi">3</span>    <span class="o">-</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">Qr_present</span> <span class="o">=</span> <span class="n">Q_total</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">H_present</span>  <span class="o">=</span> <span class="n">H</span></div>


<div class="viewcode-block" id="evolve"><a class="viewcode-back" href="../../../../thermal_history.mantle_models.knibbe_westrenen18.main.html#thermal_history.mantle_models.knibbe_westrenen18.main.evolve">[docs]</a><span class="k">def</span> <span class="nf">evolve</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculates one timestep of the model.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#Read in variables from model and parameters file</span>
    <span class="n">mantle</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mantle</span>
    <span class="n">prm</span>    <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span>


    <span class="n">Tm</span>   <span class="o">=</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Tm</span>      <span class="c1">#average mantle temperature</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">time</span>

    <span class="n">r_surf</span>  <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_surf</span>   <span class="c1">#upper radius</span>
    <span class="n">rc</span>      <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span>    <span class="c1">#lower radius</span>
    <span class="n">rl</span>      <span class="o">=</span> <span class="n">r_surf</span><span class="o">-</span><span class="n">mantle</span><span class="o">.</span><span class="n">Dl</span>
    <span class="n">r_crust</span> <span class="o">=</span> <span class="n">r_surf</span><span class="o">-</span><span class="n">mantle</span><span class="o">.</span><span class="n">D_crust</span>
    <span class="n">r_reg</span>   <span class="o">=</span> <span class="n">r_surf</span><span class="o">-</span><span class="n">prm</span><span class="o">.</span><span class="n">regolith_size</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">surface_gravity</span>  <span class="c1">#Surface gravity, assumed constant in mantle</span>

    <span class="n">k_reg</span>    <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">regolith_conductivity</span>
    <span class="n">k_crust</span>  <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">crust_k</span> <span class="c1">#thermal conductivity of the crust</span>
    <span class="n">k_upper</span>  <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_k_upper</span>  <span class="c1">#thermal conductivity in upper mantle</span>
    <span class="n">k_lower</span>  <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_k_lower</span>  <span class="c1">#thermal conductivity in lower mantle</span>

    <span class="n">T_surf</span>   <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">T_surf</span>                   <span class="c1">#Surface temperature</span>
    <span class="n">rho_man</span>  <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_density</span>          <span class="c1">#Mantle density</span>
    <span class="n">rho_crust</span><span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">crust_density</span>           <span class="c1">#Crust density</span>
    <span class="n">alpha</span>    <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_alpha_T</span>          <span class="c1">#volumetric expansion</span>
    <span class="n">latent_heat</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_latent_heat</span>
    <span class="n">cp_crust</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">crust_cp</span>

    <span class="n">kappa</span>    <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_diffusivity_T</span>    <span class="c1">#thermal diffusivity</span>
    <span class="n">cp</span>       <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_cp</span>               <span class="c1">#specific heat capacity</span>
    <span class="n">Rg</span>       <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">Rg</span>                      <span class="c1">#Gas constant</span>
    <span class="n">Av</span>       <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">activation_energy</span>       <span class="c1">#Activation energy</span>
    <span class="n">V</span>        <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">activation_volume</span>       <span class="c1">#Activation volume</span>
    <span class="n">eta_ref</span>  <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">viscosity_ref</span>           <span class="c1">#Reference viscosity</span>
    <span class="n">T_ref</span>    <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">viscosity_ref_temperature</span> <span class="c1">#Temperature for reference viscosity</span>
    <span class="n">b_factor</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">b_factor</span>                <span class="c1">#&#39;b&#39; factor for scalings</span>

    <span class="n">delta_upper</span><span class="p">,</span> <span class="n">delta_lower</span> <span class="o">=</span> <span class="n">mantle</span><span class="o">.</span><span class="n">delta_upper</span><span class="p">,</span> <span class="n">mantle</span><span class="o">.</span><span class="n">delta_lower</span>
    <span class="n">rb</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">+</span> <span class="n">delta_lower</span>
    <span class="n">rm</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">-</span> <span class="n">delta_upper</span>

    <span class="c1">#Get Tcmb</span>
    <span class="n">T_cmb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">T_cmb</span>

    <span class="c1">#Temperatures</span>
    <span class="n">T_upper</span> <span class="o">=</span> <span class="n">Tm</span>
    <span class="n">T_lower</span> <span class="o">=</span> <span class="n">Tm</span> <span class="o">+</span> <span class="p">(</span><span class="n">rl</span><span class="o">-</span><span class="n">delta_upper</span><span class="o">-</span><span class="n">rc</span><span class="o">-</span><span class="n">delta_lower</span><span class="p">)</span><span class="o">*</span><span class="n">Tm</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">g</span><span class="o">/</span><span class="n">cp</span>

    <span class="n">T_lid</span> <span class="o">=</span> <span class="n">T_upper</span> <span class="o">-</span> <span class="mf">2.21</span> <span class="o">*</span> <span class="n">prm</span><span class="o">.</span><span class="n">Rg</span><span class="o">*</span><span class="n">T_upper</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">Av</span>

    <span class="n">dT_upper</span>  <span class="o">=</span> <span class="n">T_upper</span><span class="o">-</span><span class="n">T_lid</span>
    <span class="n">dT_lower</span>  <span class="o">=</span> <span class="n">T_cmb</span><span class="o">-</span><span class="n">T_lower</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">it</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dT_lower</span> <span class="o">=</span> <span class="n">T_cmb</span><span class="o">-</span><span class="n">Tm</span>

    <span class="n">Tup_av</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_lid</span><span class="o">+</span><span class="n">T_upper</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">Tlow_av</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_cmb</span><span class="o">+</span><span class="n">T_lower</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1">#Pressures at base of lid, CMB and mid-mantle (assuming constant rho and g)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">radial_density_grid</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">r_crust</span><span class="p">,</span> <span class="n">r_reg</span><span class="p">,</span> <span class="n">r_surf</span><span class="p">,</span> <span class="n">rho_man</span><span class="p">,</span> <span class="n">rho_crust</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pressure</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
    <span class="n">P_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rl</span><span class="o">-</span><span class="n">delta_upper</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
    <span class="n">P_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rc</span><span class="o">+</span><span class="n">delta_lower</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>

    <span class="c1">#Viscosities in the mantle. Scales eta_0 with activation energy (relative to T_ref) and volume (relative to 0 Pa).</span>
    <span class="n">eta</span>        <span class="o">=</span> <span class="n">eta_ref</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">Av</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="n">Rg</span>  <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Tm</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">T_ref</span><span class="p">))</span>
    <span class="n">eta_upper</span>  <span class="o">=</span> <span class="n">eta_ref</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">Av</span><span class="o">+</span><span class="n">P_upper</span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="n">Rg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Tup_av</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">T_ref</span><span class="p">))</span>
    <span class="n">eta_lower</span>  <span class="o">=</span> <span class="n">eta_ref</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">Av</span><span class="o">+</span><span class="n">P_lower</span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="n">Rg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Tlow_av</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">T_ref</span><span class="p">))</span>

    <span class="c1"># Rayleigh numbers.</span>
    <span class="n">Rai</span> <span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">rho_man</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Tm</span><span class="o">-</span><span class="n">T_surf</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dT_lower</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">r_surf</span><span class="o">-</span><span class="n">rc</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span>
    <span class="n">Rai_c</span> <span class="o">=</span> <span class="mf">0.28</span><span class="o">*</span><span class="n">Rai</span><span class="o">**</span><span class="mf">0.21</span>

    <span class="n">Ra</span> <span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">rho_man</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dT_upper</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dT_lower</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">rl</span><span class="o">-</span><span class="n">rc</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">T_cmb</span><span class="o">-</span><span class="n">T_lower</span><span class="o">+</span><span class="n">T_upper</span><span class="o">-</span><span class="n">T_lid</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">Ra</span> <span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">rho_man</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">rl</span><span class="o">-</span><span class="n">rc</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span>
    <span class="n">Ra_c</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">critical_rayleigh</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dT_lower</span><span class="p">,</span> <span class="n">dT_upper</span><span class="p">])</span>

    <span class="c1"># breakpoint()</span>

    <span class="c1">#TBL sizes. TESTING</span>
    <span class="n">delta_upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">rl</span><span class="o">-</span><span class="n">rc</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Ra_c</span><span class="o">/</span><span class="n">Ra</span><span class="p">)</span><span class="o">**</span><span class="n">b_factor</span>

    <span class="c1"># breakpoint()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">T_cmb</span><span class="o">-</span><span class="n">T_lower</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">delta_lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">eta_lower</span><span class="o">*</span><span class="n">Rai_c</span> <span class="o">/</span> <span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">rho_man</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dT_lower</span><span class="p">))))</span><span class="o">**</span><span class="n">b_factor</span> <span class="c1">#Use abs(dT_lower) otherwise it is not defined</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta_lower</span> <span class="o">=</span> <span class="n">mantle</span><span class="o">.</span><span class="n">delta_lower</span> <span class="c1">#Use previous time steps value</span>

    <span class="c1">#Set boundaries the same for first timestep</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">it</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">delta_lower</span> <span class="o">=</span> <span class="n">delta_upper</span>

    <span class="c1">#My Way</span>
    <span class="k">if</span> <span class="n">rl</span><span class="o">-</span><span class="n">delta_upper</span> <span class="o">&lt;</span> <span class="n">rc</span><span class="o">+</span><span class="n">delta_lower</span><span class="p">:</span>
        <span class="n">delta_upper</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">-</span> <span class="p">(</span><span class="n">rc</span><span class="o">+</span><span class="n">delta_lower</span><span class="p">)</span>
    <span class="c1"># #KW way</span>
    <span class="c1"># if rl-delta_upper &lt; rc:</span>
    <span class="c1">#     delta_upper = rl - rc</span>

    <span class="c1">#Recalculate T_lower, rb/rm now deltas have been calculated</span>
    <span class="n">T_lower</span> <span class="o">=</span> <span class="n">Tm</span> <span class="o">+</span> <span class="p">(</span><span class="n">rl</span><span class="o">-</span><span class="n">delta_upper</span><span class="o">-</span><span class="n">rc</span><span class="o">-</span><span class="n">delta_lower</span><span class="p">)</span><span class="o">*</span><span class="n">Tm</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">g</span><span class="o">/</span><span class="n">cp</span>
    <span class="n">rb</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">+</span> <span class="n">delta_lower</span>
    <span class="n">rm</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">-</span> <span class="n">delta_upper</span>
    

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">delta_lower</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">delta_upper</span><span class="p">):</span>
        <span class="nb">breakpoint</span><span class="p">()</span>


    <span class="c1">#Fluxes through TBL</span>
    <span class="n">dT_upper</span>  <span class="o">=</span> <span class="n">T_upper</span><span class="o">-</span><span class="n">T_lid</span>
    <span class="n">dT_lower</span>  <span class="o">=</span> <span class="n">T_cmb</span><span class="o">-</span><span class="n">T_lower</span>

    <span class="n">F_m</span> <span class="o">=</span> <span class="n">k_upper</span> <span class="o">*</span> <span class="n">dT_upper</span> <span class="o">/</span> <span class="n">delta_upper</span>
    <span class="n">F_cmb</span> <span class="o">=</span> <span class="n">k_lower</span> <span class="o">*</span> <span class="n">dT_lower</span> <span class="o">/</span> <span class="n">delta_lower</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dT_lower</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">F_cmb</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># r_crust = r_surf-38e3 #Fixed 38km thick crust</span>
    <span class="n">mass_crust</span>  <span class="o">=</span> <span class="mi">4</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_surf</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="n">r_crust</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho_crust</span>
    <span class="n">mass_mantle</span> <span class="o">=</span> <span class="mi">4</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_crust</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="n">rc</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho_man</span>

    <span class="c1">#Radiogenic heating</span>
    <span class="n">age</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">4.3e9</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">ys</span> <span class="o">-</span> <span class="n">time</span><span class="p">)</span>

    <span class="c1">#Half lives in seconds. Must be the same as defined in setup() above</span>
    <span class="n">HPE_half_lives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.25e9</span><span class="p">,</span> <span class="mf">7.04e8</span><span class="p">,</span> <span class="mf">4.47e9</span><span class="p">,</span> <span class="mf">1.40e10</span><span class="p">])</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">ys</span>

    <span class="c1">#Total amount of radiogenic heating in the mantle+crust</span>
    <span class="n">Q_K</span><span class="p">,</span> <span class="n">Q_U235</span><span class="p">,</span> <span class="n">Q_U238</span><span class="p">,</span> <span class="n">Q_Th</span> <span class="o">=</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Qr_present</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">age</span><span class="o">/</span><span class="n">HPE_half_lives</span><span class="p">)</span>

    <span class="c1">#Crustal heating rate, W/kg</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mantle</span><span class="o">.</span><span class="n">H_present</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">age</span><span class="o">/</span><span class="n">HPE_half_lives</span><span class="p">))</span>

    <span class="c1">#Mantle heating rate, W/kg</span>
    <span class="n">H_man</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">Q_K</span><span class="p">,</span> <span class="n">Q_U235</span><span class="p">,</span> <span class="n">Q_U238</span><span class="p">,</span> <span class="n">Q_Th</span><span class="p">])</span> <span class="o">-</span> <span class="n">H</span> <span class="o">*</span> <span class="n">rho_crust</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">r_surf</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="n">r_crust</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="n">mass_mantle</span>

    <span class="c1">#Radiogenic heating totals</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Qr_crust</span> <span class="o">=</span> <span class="n">mass_crust</span>  <span class="o">*</span> <span class="n">H</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Qr</span>       <span class="o">=</span> <span class="n">rho_man</span> <span class="o">*</span> <span class="mi">4</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">rl</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="n">rc</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">H_man</span>


    <span class="c1">#Triple conductive layers</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="n">joint_conduction</span><span class="p">(</span><span class="n">T_surf</span><span class="p">,</span> <span class="n">T_lid</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">r_surf</span><span class="p">,</span> <span class="n">r_reg</span><span class="p">,</span> <span class="n">r_crust</span><span class="p">,</span>         <span class="n">rl</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">H</span><span class="o">*</span><span class="n">rho_crust</span><span class="p">,</span> <span class="n">H</span><span class="o">*</span><span class="n">rho_crust</span><span class="p">,</span> <span class="n">H_man</span><span class="o">*</span><span class="n">rho_man</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">k_reg</span><span class="p">,</span>         <span class="n">k_crust</span><span class="p">,</span>         <span class="n">k_upper</span><span class="p">])</span>

    <span class="n">sol_reg</span>   <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sol_crust</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sol_lith</span>  <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#Heat fluxes through lid and surface</span>
    <span class="n">F_lid</span> <span class="o">=</span> <span class="o">-</span><span class="n">k_upper</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">sol_lith</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">rl</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">rl</span><span class="o">*</span><span class="p">(</span><span class="n">H_man</span><span class="o">*</span><span class="n">rho_man</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">k_upper</span><span class="p">))</span>

    <span class="n">F_surf</span> <span class="o">=</span> <span class="o">-</span><span class="n">k_reg</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">sol_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r_surf</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">r_surf</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">*</span><span class="n">rho_crust</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">k_reg</span><span class="p">))</span>

    <span class="c1">#Radial profiles</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">radial_density_grid</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">r_crust</span><span class="p">,</span> <span class="n">r_reg</span><span class="p">,</span> <span class="n">r_surf</span><span class="p">,</span> <span class="n">rho_man</span><span class="p">,</span> <span class="n">rho_crust</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    
    <span class="c1">#First 4 nodes are interfaces rc-&gt;rl (assume linear between)</span>
    <span class="n">T</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">T_cmb</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">T_lid</span><span class="p">])</span>
    
    <span class="c1">#Conductive layers</span>
    <span class="n">T</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span>  <span class="n">sol_lith</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">+</span> <span class="n">sol_lith</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">H_man</span><span class="o">*</span><span class="n">rho_man</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">k_upper</span><span class="p">)</span> <span class="c1">#Lithosphere</span>

    <span class="n">T</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="mi">10</span><span class="p">:]</span> <span class="o">=</span>  <span class="n">sol_crust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="mi">10</span><span class="p">:]</span> <span class="o">+</span> <span class="n">sol_crust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">H</span><span class="o">*</span><span class="n">rho_crust</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="mi">10</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">k_crust</span><span class="p">)</span> <span class="c1">#Crust</span>

    <span class="n">T</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="mi">20</span><span class="p">:]</span> <span class="o">=</span>  <span class="n">sol_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="mi">20</span><span class="p">:]</span> <span class="o">+</span> <span class="n">sol_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">H</span><span class="o">*</span><span class="n">rho_crust</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="mi">20</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">k_reg</span><span class="p">)</span> <span class="c1">#Regolith</span>

    <span class="c1"># T[4:] = T_lid - (r[4:]-rl)*(T_lid-T_surf)/(r_surf-rl)</span>

    <span class="c1">#Mantle Melting</span>
    <span class="n">D_ref</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">r_surf</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">prm</span><span class="o">.</span><span class="n">r_surf</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1">#Calculate volume of mantle melting and volumetric average melt fraction</span>
    <span class="n">V_melt</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">melting_radii</span><span class="p">,</span> <span class="n">dm_dT</span><span class="p">,</span> <span class="n">profiles</span> <span class="o">=</span> <span class="n">melt</span><span class="o">.</span><span class="n">mantle_melt</span><span class="p">(</span><span class="n">D_ref</span><span class="p">,</span> <span class="n">mantle</span><span class="o">.</span><span class="n">D_crust</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_solidus_params</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">mantle_liquidus_params</span><span class="p">)</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">melting_radii</span> <span class="o">=</span> <span class="n">melting_radii</span>

    <span class="k">if</span> <span class="n">V_melt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">Vm</span>     <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">rl</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">rc</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1">#Convection velocity</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">convection_velocity</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ra</span><span class="o">/</span><span class="n">Ra_c</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1">#Crustal growth</span>
        <span class="n">d_crust_dt</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">ma</span> <span class="o">*</span> <span class="n">V_melt</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r_surf</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">St</span> <span class="o">=</span> <span class="n">latent_heat</span><span class="o">*</span><span class="n">V_melt</span><span class="o">*</span><span class="n">dm_dT</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">Vm</span><span class="p">)</span>

        <span class="c1">#Thermal energy associated with crustal growth.</span>
        <span class="n">crust_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho_crust</span><span class="o">*</span><span class="n">latent_heat</span> <span class="o">+</span> <span class="n">rho_crust</span><span class="o">*</span><span class="n">cp_crust</span><span class="o">*</span><span class="p">(</span><span class="n">T_upper</span><span class="o">-</span><span class="n">T_lid</span><span class="p">))</span><span class="o">*</span><span class="n">d_crust_dt</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">d_crust_dt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">crust_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">St</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">dDl_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">F_lid</span><span class="o">-</span><span class="n">F_m</span> <span class="o">+</span> <span class="n">crust_term</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rho_man</span><span class="o">*</span><span class="n">cp</span><span class="o">*</span><span class="p">(</span><span class="n">T_upper</span><span class="o">-</span><span class="n">T_lid</span><span class="p">))</span> <span class="c1">#Lithosphere growth</span>


    <span class="c1">#Force crust to be thinner that lithosphere</span>
    <span class="k">if</span> <span class="n">mantle</span><span class="o">.</span><span class="n">D_crust</span> <span class="o">+</span> <span class="n">d_crust_dt</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Dl</span> <span class="o">+</span> <span class="n">mantle</span><span class="o">.</span><span class="n">dDl_dt</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
        <span class="n">d_crust_dt</span> <span class="o">=</span> <span class="p">((</span><span class="n">mantle</span><span class="o">.</span><span class="n">Dl</span> <span class="o">+</span> <span class="n">mantle</span><span class="o">.</span><span class="n">dDl_dt</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="o">-</span> <span class="n">mantle</span><span class="o">.</span><span class="n">D_crust</span><span class="p">)</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">crust_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho_crust</span><span class="o">*</span><span class="n">latent_heat</span> <span class="o">+</span> <span class="n">rho_crust</span><span class="o">*</span><span class="n">cp_crust</span><span class="o">*</span><span class="p">(</span><span class="n">T_upper</span><span class="o">-</span><span class="n">T_lid</span><span class="p">))</span><span class="o">*</span><span class="n">d_crust_dt</span>


    <span class="c1">#Mantle energy budget</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Q_surf</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r_surf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F_surf</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Q_cmb</span>  <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rc</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F_cmb</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Q_conv</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rl</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F_m</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Q_lid</span>  <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rl</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F_lid</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Q_vol</span>  <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rl</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">crust_term</span>

    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">Tm</span><span class="o">/</span><span class="n">T_upper</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#KW keep this as 1</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">rl</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="n">rc</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">rho_man</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">dT_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">mantle</span><span class="o">.</span><span class="n">Q_cmb</span> <span class="o">-</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Q_conv</span> <span class="o">-</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Q_vol</span> <span class="o">+</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Qr</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">mass</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">St</span><span class="p">)</span><span class="o">*</span><span class="n">epsilon</span><span class="p">)</span>

    <span class="c1">#Save variables</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">dD_crust_dt</span> <span class="o">=</span> <span class="n">d_crust_dt</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">St</span> <span class="o">=</span> <span class="n">St</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">T_upper</span> <span class="o">=</span> <span class="n">T_upper</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">T_lower</span> <span class="o">=</span> <span class="n">T_lower</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">delta_upper</span> <span class="o">=</span> <span class="n">delta_upper</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">delta_lower</span> <span class="o">=</span> <span class="n">delta_lower</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">Ra</span> <span class="o">=</span> <span class="n">Ra</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Rai</span> <span class="o">=</span> <span class="n">Rai</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">Ra_c</span> <span class="o">=</span> <span class="n">Ra_c</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Rai_c</span> <span class="o">=</span> <span class="n">Rai_c</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">dT_upper</span> <span class="o">=</span> <span class="n">dT_upper</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">dT_lower</span> <span class="o">=</span> <span class="n">dT_lower</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">eta_upper</span> <span class="o">=</span> <span class="n">eta_upper</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">eta_lower</span> <span class="o">=</span> <span class="n">eta_lower</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">Qs</span> <span class="o">=</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Q_cmb</span> <span class="o">-</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Q_surf</span> <span class="o">+</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Qr</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">T_cmb</span>  <span class="o">=</span> <span class="n">T_cmb</span></div>


<div class="viewcode-block" id="update"><a class="viewcode-back" href="../../../../thermal_history.mantle_models.knibbe_westrenen18.main.html#thermal_history.mantle_models.knibbe_westrenen18.main.update">[docs]</a><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Update variables based on what was calculated in the evolve() function.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mantle</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mantle</span>
    <span class="n">prm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span>

    <span class="n">mantle</span><span class="o">.</span><span class="n">Tm</span> <span class="o">+=</span> <span class="n">mantle</span><span class="o">.</span><span class="n">dT_dt</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">Dl</span> <span class="o">+=</span> <span class="n">mantle</span><span class="o">.</span><span class="n">dDl_dt</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">mantle</span><span class="o">.</span><span class="n">D_crust</span> <span class="o">+=</span> <span class="n">mantle</span><span class="o">.</span><span class="n">dD_crust_dt</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">if</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Dl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No Lithosphere&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mantle</span><span class="o">.</span><span class="n">Dl</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">r_surf</span><span class="o">-</span><span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="o">+</span><span class="n">mantle</span><span class="o">.</span><span class="n">delta_lower</span><span class="p">):</span>
        <span class="n">mantle</span><span class="o">.</span><span class="n">Dl</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_surf</span><span class="o">-</span><span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="o">+</span><span class="n">mantle</span><span class="o">.</span><span class="n">delta_lower</span></div>

<span class="c1">#Required parameters. Used to check given parameters before start. Give the name of the parameter as the key with a description as the associated value within the dictionary.</span>

<span class="n">required_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Tm&#39;</span><span class="p">:</span> <span class="s1">&#39;Initial temperature of the mid mantle [K]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;T_surf&#39;</span><span class="p">:</span> <span class="s1">&#39;Surface temperature [K]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;r_surf&#39;</span><span class="p">:</span> <span class="s1">&#39;Radius of the planet [m]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;r_crust&#39;</span><span class="p">:</span> <span class="s1">&#39;Radius of the base of the crust [m]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;stagnant_lid_thickness&#39;</span><span class="p">:</span> <span class="s1">&#39;Initial thickness of the stangant lid [m]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_density&#39;</span><span class="p">:</span> <span class="s1">&#39;Mantle density [kg/m^3]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;crust_density&#39;</span><span class="p">:</span> <span class="s1">&#39;Crust density [kg/m^3]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_k_upper&#39;</span><span class="p">:</span> <span class="s1">&#39;Thermal conductivity of the upper mantle [W/K/m]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_k_lower&#39;</span><span class="p">:</span> <span class="s1">&#39;Thermal conductivity of the lower mantle [W/K/m]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;crust_k&#39;</span><span class="p">:</span> <span class="s1">&#39;Thermal conductivity of the crust [W/K/m]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_alpha_T&#39;</span><span class="p">:</span> <span class="s1">&#39;Thermal expansivity of the mantle [/K]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_cp&#39;</span><span class="p">:</span> <span class="s1">&#39;Mantle specific heat capacity [J/kg/K]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;crust_cp&#39;</span><span class="p">:</span> <span class="s1">&#39;Erupted magma specific heat capacity [J/kg/K]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_diffusivity_T&#39;</span><span class="p">:</span> <span class="s1">&#39;Mantle thermal diffusivity [m^2/s]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;activation_energy&#39;</span><span class="p">:</span> <span class="s1">&#39;Activation energy for viscosity temperature scaling. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;activation_volume&#39;</span><span class="p">:</span> <span class="s1">&#39;Activation volume for viscosity pressure scaling [m^3/mol]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;viscosity_ref&#39;</span><span class="p">:</span> <span class="s1">&#39;Reference viscosity at a specified temperature and atomospheric pressure [Pa s]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;viscosity_ref_temperature&#39;</span><span class="p">:</span> <span class="s1">&#39;Temperature of the reference viscosity [K]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;b_factor&#39;</span><span class="p">:</span> <span class="s1">&#39;Exponent used in scaling the thermal boundary layer thickness. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;HPE_fraction&#39;</span><span class="p">:</span> <span class="s1">&#39;Fraction of heat producing elements in the bulk mantle relative to the crust. Float.&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;HPE_concentrations&#39;</span><span class="p">:</span> <span class="s1">&#39;Mass fractions of heat producing elements present in the crust in the order [K, U, Th]. List[Float]&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;regolith_conductivity&#39;</span><span class="p">:</span> <span class="s1">&#39;Thermal conductivity of the surface regolith. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;regolith_size&#39;</span><span class="p">:</span> <span class="s1">&#39;Size of the regolith layer [m]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;surface_gravity&#39;</span><span class="p">:</span> <span class="s1">&#39;Gravity at the surface, only used if not using a core model.&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;critical_rayleigh&#39;</span><span class="p">:</span> <span class="s1">&#39;Critical Rayleigh number&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_solidus_params&#39;</span><span class="p">:</span> <span class="s1">&#39;Mantle solidus pressure polynomials. List&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_liquidus_params&#39;</span><span class="p">:</span> <span class="s1">&#39;Mantle liquidus pressure polynomials. List&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;convection_velocity&#39;</span><span class="p">:</span> <span class="s1">&#39;Typical convection velocity for scaling volume of erupted magma [m/s]. Float&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;mantle_latent_heat&#39;</span><span class="p">:</span> <span class="s1">&#39;Latent heat of melting for mantle [J/kg]&#39;</span>
<span class="p">}</span>

<span class="c1">#This fixed the error in the original code of Knibbe and Van Westrenen (2018). They numerically solved the problem</span>
<span class="c1">#rather than analytically solving it leading to incorrect values at specific timesteps early on in the model runs.</span>
<span class="c1">#The main conclusions of the paper remain unchanged after fixing it.</span>
<div class="viewcode-block" id="joint_conduction"><a class="viewcode-back" href="../../../../thermal_history.mantle_models.knibbe_westrenen18.main.html#thermal_history.mantle_models.knibbe_westrenen18.main.joint_conduction">[docs]</a><span class="k">def</span> <span class="nf">joint_conduction</span><span class="p">(</span><span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Steady state spherical conduction solution for n shells.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T_upper : float</span>
<span class="sd">        Temperature at top of outer shell</span>
<span class="sd">    T_lower : float</span>
<span class="sd">        Temperature at bottom of inner shell</span>
<span class="sd">    r : array</span>
<span class="sd">        Radii of outer shell through to inner radii of inner shell.</span>
<span class="sd">    H : array</span>
<span class="sd">        Internal heating rates (W/m^3) of shells from outer to inner</span>
<span class="sd">    k : array</span>
<span class="sd">        Thermal conductivities (W/m/K) of shells from outer to inner</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        list of coefficients for solution for each </span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Shells are defined by an array of size n for their thermal conducitivities (W/m/K) and</span>
<span class="sd">    internal volumetric heating rates (W/m^3). Radii are specified by an array of size n+1</span>
<span class="sd">    of the boundaries and interfaces. Index 0 of arrays refer to the values of the outer-most shell, proceeding</span>
<span class="sd">    to the inner-most shell. Temperature boundary conditions for the radii r0 and rn are required, with continuity</span>
<span class="sd">    of temperature and heat flux assumed at each interface (see diagram below).</span>

<span class="sd">    __________ r0, T_upper</span>

<span class="sd">    k1, H1</span>

<span class="sd">    __________ r1</span>

<span class="sd">    k2, H2</span>

<span class="sd">    __________ r2</span>

<span class="sd">    ...</span>

<span class="sd">    kn, Hn</span>
<span class="sd">    </span>
<span class="sd">    __________ rn, T_lower</span>

<span class="sd">    Returns an array of coefficients (A1,B1...An,Bn) to the solution</span>

<span class="sd">    T(r) = Ai/r + Bi - Hi/(6 * ki) * r**2</span>

<span class="sd">    for each shell where i is in the range [1,n].</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Example for 2 shells:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        #Temperature Boundary conditions</span>
<span class="sd">        T_upper=1</span>
<span class="sd">        T_lower=1</span>

<span class="sd">        #Radii of 2 shells, outer shell between r=0.5:1, inner shell between r=0:0.5</span>
<span class="sd">        r = [1,0.5,0]</span>

<span class="sd">        #Internat heating rates and conductivities for outer and inner shells.</span>
<span class="sd">        H = [0,0]</span>
<span class="sd">        k = [1,1]</span>

<span class="sd">        solution = joint_conduction(T_upper, T_lower, r, H, k)</span>
<span class="sd">        A1, B1 = solution[:2]</span>
<span class="sd">        A2, B2 = solution[2:]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">r</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">H</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="c1">#Define variables l1/2 for simplicity</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>

    <span class="c1">#Initialise sizes of A matrix and b vector</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1">#Boundary conditions at r[0] and r[-1]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">T_upper</span> <span class="o">+</span> <span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">*</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">b</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_lower</span> <span class="o">+</span> <span class="n">H</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">L</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1">#Fixed flux and temperature at interfaces r[1:-1]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">4</span>

        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span>   <span class="n">j</span><span class="p">:</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#Temperature continuity</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>       <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">k</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>  <span class="mi">0</span><span class="p">]</span> <span class="c1">#Flux continuity</span>

        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">L</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">H</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">L</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#Temperature continuity</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">H</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>         <span class="c1">#Flux continuity</span>

        <span class="n">i</span><span class="o">+=</span><span class="mi">2</span>

    <span class="c1">#Solve the system for [A1,B1,...,An,Bn]</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="c1">#Return list where 0th index gives array(A1,B1) and (n-1) index gives array(An,Bn)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span></div>



<span class="c1"># def joint_conduction_old(T0, T2, r0, r1, r2, H1, H2, k1, k2):</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     Steady state spherical conduction solution for n shells.</span>
<span class="c1">#</span>
<span class="c1">#     ---------- r0, T_upper</span>
<span class="c1">#     k1, H1</span>
<span class="c1">#     ---------- r1</span>
<span class="c1">#     k2, H2</span>
<span class="c1">#     ---------- r2</span>
<span class="c1">#     ...</span>
<span class="c1">#</span>
<span class="c1">#     kn, Hn</span>
<span class="c1">#     ---------- rn, T_lower</span>
<span class="c1">#</span>
<span class="c1">#     Shells are defined by an array of size n for their thermal conducitivities (W/m/K) and</span>
<span class="c1">#     internal volumetric heating rates (W/m^3). Radii are specified by an array of size n+1</span>
<span class="c1">#     of the boundaries and interfaces. Index 0 of arrays refer to the values of the outer-most shell, proceeding</span>
<span class="c1">#     to the inner-most shell. Temperature boundary conditions for the radii r0 and rn are required, with continuity</span>
<span class="c1">#     of temperature and heat flux assumed at each interface.</span>
<span class="c1">#</span>
<span class="c1">#     Returns an array of coefficients (A1,B1...An,Bn) to the solution</span>
<span class="c1">#</span>
<span class="c1">#     T(r) = Ai/r + Bi - Hi/(6 * ki) * r**2</span>
<span class="c1">#</span>
<span class="c1">#     for each shell where i is in the range [1,n].</span>
<span class="c1">#</span>
<span class="c1">#     ______________________________________</span>
<span class="c1">#     Example for 2 shells</span>
<span class="c1">#</span>
<span class="c1">#     #Temperature Boundary conditions</span>
<span class="c1">#     T_upper=1</span>
<span class="c1">#     T_lower=1</span>
<span class="c1">#</span>
<span class="c1">#     #Radii of 2 shells, outer shell between r=0.5:1, inner shell between r=0:0.5</span>
<span class="c1">#     r = [1,0.5,0]</span>
<span class="c1">#</span>
<span class="c1">#     #Internat heating rates and conductivities for outer and inner shells.</span>
<span class="c1">#     H = [0,0]</span>
<span class="c1">#     k = [1,1]</span>
<span class="c1">#</span>
<span class="c1">#     solution = joint_conduction(T_upper, T_lower, r, H, k)</span>
<span class="c1">#     A1, B1 = solution[:2]</span>
<span class="c1">#     A2, B2 = solution[2:]</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#</span>
<span class="c1">#     #Define variables l1/2 for simplicity</span>
<span class="c1">#     l1, l2 = 1/(6*k1), 1/(6*k2)</span>
<span class="c1">#</span>
<span class="c1">#     #Set up linear equations in form Ax=b</span>
<span class="c1">#     b = np.array([T0 + H1 * l1 * r0**2,</span>
<span class="c1">#                   T2 + H2 * l2 * r2**2,</span>
<span class="c1">#                   (H2*l2 - H1*l1) * r1**2,</span>
<span class="c1">#                   2*r1**3 * (l1*H1*(k1/k2) - l2*H2)])</span>
<span class="c1">#</span>
<span class="c1">#     A = np.array([[1/r0, 1, 0, 0],</span>
<span class="c1">#                   [0, 0, 1/r2, 1],</span>
<span class="c1">#                   [-1/r1, -1, 1/r1, 1],</span>
<span class="c1">#                   [-k1/k2, 0, 1, 0]])</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     # Ac, Bc, Al, Bl = np.linalg.solve(A,b)</span>
<span class="c1">#</span>
<span class="c1">#     # rc = np.linspace(r1,r0)</span>
<span class="c1">#     # rl = np.linspace(r2,r1)</span>
<span class="c1">#     # Tc = Ac/rc + Bc - H1*l1*rc**2</span>
<span class="c1">#     # Tl = Al/rl + Bl - H2*l2*rl**2</span>
<span class="c1">#     # plt.plot(rl,Tl)</span>
<span class="c1">#     # plt.plot(rc,Tc)</span>
<span class="c1">#     # plt.show()</span>
<span class="c1">#     # breakpoint()</span>
<span class="c1">#</span>
<span class="c1">#     #Solve the system for [A1,B1,A2,B2]</span>
<span class="c1">#     return np.linalg.solve(A,b)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Sam Greenwood

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>